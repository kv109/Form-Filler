<html>
<head>
    <title>FormFiller Configuration Page</title>

    <style type="text/css">

body {
    margin: 0;
    padding: 0;
    font-family: arial;
    font-size: 12px;
}
.container {
    margin-left: auto;
    margin-right: auto;
    width: 70%;
}

.bar {
    padding-top: 50px;
}

.bar1 {
    width: 26%;
    float: left;
    background-color: #eee;
    padding-left: 30px;
    padding-right: 15px;
    border-left:   2px solid #222;
    border-right:  2px solid #222;
    border-bottom: 2px solid #222;
}
.bar1 .element {
    margin-bottom: 5px;
    padding: 5px;
}
.bar2 {
    width: 60%;
    float: left;
    padding-left: 30px;
    padding-right: 15px;
    border-bottom: 2px solid #222;
    border-right:  2px solid #222;
}
.formContainer h2 {
    color: #0036db;
    font-size: inherit;
    text-transform: uppercase;
    font-weight: bold;
    padding: 0;
    margin: 0;
    margin-bottom: 5px;
    text-align: center;
}

.formContainer {
    text-align: left;
    width: 400px;
}

.typeContainer {
    margin-top: 2px;
    margin-bottom: 40px;
    text-align: right;
}

.moreLessSpan {
    position: relative;
    top: -22px;
    left: 130px;
    color: #999;
}
.typeContainer  a {
    text-decoration: none;
    padding: 0px 5px;
}

.inputContainer {
    width: 540px;
    text-align: left;
}

.inputContainer .label {
    width: 90px;
    display: table-cell;
    font-weight: bold;
    text-align: right;
    padding-right: 10px;

}
.inputContainer span {
    width: 300px;
    display: table-cell;
    text-align: left;
}

.welcome {
    padding: 5px;
    font-weight: bold;
    background-color: #222;
    color: #ffb400;
    font-size: large;
    text-align: center;
    text-shadow: red 0.1em 0.1em 0.2em;
    border-bottom: 2px solid #ffb400;
}

.logo {
    position: fixed;
    right: 0px;
    top: 0px;
}

.menu {
    text-align: justify;
}

.popup {
    position: fixed;
    background-color: white;
    background-color: #7b8;
    text-shadow: black 0.1em 0.1em 0.2em;
    font-weight: bold;
    color: white;
    padding: 10px;
    border: 2px solid green;
    text-align: center;
    margin-left: auto;
    margin-right: auto;
    width: 200px;
}

.submit {
    margin-top: 40px;
    text-align: center;
}

.showPassword .description  {
    padding: 7px;
    background-color: #ccc;
    border: 1px solid black;
    position: absolute;
    left: 320px;
    width: 200px;
}
.showPassword .description .example {
    font-family: arial;
    font-size: 11px;
    background-color: white;
    color: black;
    opacity: 0.7;
    border: 1px solid black;
    padding: 3px;
}

    </style>
    <script type="text/javascript" src="jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="tea.js"></script>
    <script type="text/javascript">
        var CONF = _AL_CONF
        var TYPES = CONF.types.get();
        
        function defaultAlValues() {
            var defaultAlValues = {};
            for(var i = 0; i<TYPES.length; i++) {
                var type = TYPES[i];
                var defaultValue = 'Set your ' + type + ' in FormFiller options page';
                defaultValue = Tea.encrypt(defaultValue, CONF.encKey.get());
                defaultAlValues[type] = [defaultValue];
            }

            return defaultAlValues;
        }

        function saveOptions() {
            var formValues = getForm().serializeArray();
            var alValues = {}
            $.each(formValues, function(){
                if(this.value != '') {
                    var encryptedValue = Tea.encrypt(this.value, CONF.encKey.get());
                    if( alValues[this.name] == undefined ) {
                        alValues[this.name] = [encryptedValue];
                    }
                    else {
                        alValues[this.name].push(encryptedValue);
                    };
                }
            })
            CONF.alValues.set(alValues);
            showPopup();
        }

        function showPopup() {
            var popup = $('<div>');
            popup.attr('class', 'popup');
            popup.text('Options saved!');
            $('.container').append(popup);
            popup.animate({opacity: 0.0}, 2000);
        }
        
        function getForm() {
            return $('form');
        }

        function numberOfTypeInputs(type) {
            return $('input[name="' + type + '"]').length;
        }

        function generateForm() {
            var clearForm = function(){if(getForm().length) $(CONF.constants.innerFormClass + ' .inputs', getForm()).html("");}();

            var alValues = CONF.alValues.get();

            if( alValues == null ) {
                var setDefaultValues = function() {
                    alValues = defaultAlValues();
                }()
            }
            alValues.keys().forEach(function(type) {
                var values = alValues[type];
                
                generateAndAppendTypeBefore(type);

                values.forEach(function(value) {
                    value = Tea.decrypt(value, CONF.encKey.get())
                    var inputNumber = numberOfTypeInputs(type) + 1;
                    var humanName = capitalize(type) + " (" + inputNumber + ")";
                    if(type == 'password') {
                        generateAndAppendInput([type, humanName], type, {value: value});
                    }
                    else {
                        generateAndAppendInput([type, humanName], 'text', {value: value});
                    }
                })

                generateAndAppendTypeAfter(type);
            })
            appendSubmitButton();

        }

        function generateAndAppendTypeBefore(type) {
            var translation = CONF.dict.types[type];
            if( translation != undefined ) {
                translation = translation.pluralize;
            }
            else {
                translation = type;
            }
            var html = "<h2>Your " + translation + "</h2>";
            appendToFormInputs(html);
        }

        function generateAndAppendInput(name, type, opts) {
            var input = generateInput(name, type, opts);
            appendToFormInputs(input);
        }

        function generateInput(name, type, opts) {
            return generateStandardInput(name, type, opts);
        }

        function generateStandardInput(name, type, opts) {
            var name_ = name[0];
            var humanName = name[1];

            var spanForInput = $("<span>");
            var input = document.createElement("input");
            input.name = name_;
            input.type = type;
            input.size = 37;
            input.addEventListener('change', function(){
                saveOptions();
            })

            for(var prop in opts) {
                input[prop] = opts[prop];
            }

            var inputContainer = createInputContainer(humanName);
            spanForInput.append(input);
            inputContainer.append(spanForInput);
            
            return inputContainer;
        }

        function generateAndAppendTypeAfter(type) {
            var container = $('<div>');
            container.addClass('typeContainer');
            var customType = !~TYPES.indexOf(type);
            if(customType) container.addClass('custom');
            var addAnotherOne = $('<a>');
            addAnotherOne.text("Add");
            addAnotherOne.attr('href', '#');
            addAnotherOne.addClass('more');
            addAnotherOne.addClass('moreLess');

            var removeLastOne = $('<a>');
            removeLastOne.text("Remove");
            removeLastOne.attr('href', '#');
            removeLastOne.addClass('less');
            removeLastOne.addClass('moreLess');

            addAnotherOne.click(function(){
                var newInputContainer = addAnotherOne.parent().parent().prev().clone(true);
                var newInput = $('input', newInputContainer);
                var newInputLabel = $('label', newInputContainer);
                newInputLabel.text(newInputLabel.text().replace(/[0-9]/, numberOfTypeInputs(type) + 1));
                container.before(newInputContainer);
                newInput.val("");
                newInput.focus();
            })

            removeLastOne.click(function(){
                var lastInput = removeLastOne.parent().parent().prev();
                if( $('input', lastInput.prev().prev()).length < 1) {
                    if( removeLastOne.parents('.typeContainer').hasClass('custom') ) {
                        if( confirm('This action will remove "' + type + '" permanently. Are you sure?') ) {
                            var typeContainer = removeLastOne.parents('.typeContainer');
                            typeContainer.prev().prev().remove();
                            typeContainer.prev().remove();
                            typeContainer.remove();
                            saveOptions();
                        };
                    }
                    else {
                        alert('Cannot remove the last one');
                    }
                }
                else {
                    lastInput.remove();
                }
            })

            appendMoreLessButtons();

            appendToFormInputs(container);

            function appendMoreLessButtons() {
                var moreLessSpan = $('<span>');
                moreLessSpan.addClass('moreLessSpan');
                moreLessSpan.append(addAnotherOne);
                moreLessSpan.append(" | ");
                moreLessSpan.append(removeLastOne);
                container.append(moreLessSpan);
            }
        }

        function createInputContainer(name) {
            var container = $('<div>');
            container.addClass('inputContainer');

            var textSpan = $('<label>');
            textSpan.text(name + ": ");
            textSpan.addClass("label");
            textSpan.attr('for', name);

            container.append(textSpan);

            return container;
        }

        function appendToFormInputs(input){
            $(CONF.constants.innerFormClass + ' .inputs').append(input);
        }
        
        function appendToForm(input){
            $(CONF.constants.innerFormClass).append(input);
        }

        function appendSubmitButton(){
            appendToForm('<div class="submit"><input type="submit" /></div>');
        }

        function initialize(){
            prepareOptionsPanel();
            generateForm();
            $('.bar1').css('height', $('.bar2').height())
            setEvents();
        }

        function prepareOptionsPanel() {
            
            var value = null;

            var showPasswordContainer = $('.showPassword');
            showPasswordContainer.hover(
                function(){ $('.description', showPasswordContainer).show(); },
                function(){ $('.description', showPasswordContainer).hide(); }
            )

            var booleanOptions = ['showPassword', 'autoFill'];

            booleanOptions.forEach(function(name) {
                value = CONF.options.getValue(name);
                var inputSelector = '.' + name + ' input';
                $(inputSelector).attr('checked', value);

                $(inputSelector).click(function(){
                    CONF.options.setValue(name, $(inputSelector).is(':checked'));
                    showPopup();
                })
            })
            
            var createCustomType = $('.createCustomType');
            createCustomType.click(function(){
                var type = prompt('Enter your custom type name:');
                saveNewType(type);
            })

        }
        
        function saveNewType(type) {
            generateAndAppendTypeBefore(type);
            generateAndAppendInput([type, capitalize(type) + ' (1)'], 'text');
            generateAndAppendTypeAfter(type);
        }

        function setEvents(){
            $('.submit', getForm()).click(function(evt){
                evt.stopPropagation();
                saveOptions();
                return false;
            })
        }
    </script>

</head>

<body onload="initialize();">
    <div class="welcome">
        <img class="logo" alt="logo" src="autologger_icon128x128.png" />
        FormFiller Configuration Page
    </div>
    <div class="container">
        <div class="bar1 bar">
            <div class="menu">
                <div>
                    <div class="element showPassword">
                        <input type="checkbox" /> Show the first and the last char from your password.
                        <span class="description" style="display: none">Example: <span class="example">*a*******Z (dbl click to set)</span></span>
                    </div>
                    <div class="element autoFill">
                        <input type="checkbox" /> Fill fields automatically (no dbl click needed).
                    </div>
                    <div class="element createCustomType">
                        <button>Create Your own type</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bar2 bar">
            <div class="formContainer">
                <form action="">
                    <div class="innerForm">
                        <div class="inputs"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>